<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Burak Data Co-Pilot</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { margin: 0; font-family: 'Inter', system-ui, sans-serif; background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%); }
        .glow { box-shadow: 0 0 30px rgba(59, 130, 246, 0.6); }
        .kpi-card { 
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%); 
            border: 1px solid rgba(59, 130, 246, 0.3);
            transition: all 0.3s;
            cursor: pointer;
        }
        .kpi-card:hover { 
            border-color: rgba(59, 130, 246, 0.8);
            transform: translateY(-4px);
        }
        .system-card { 
            background: rgba(30, 41, 59, 0.9); 
            border: 1px solid rgba(148, 163, 184, 0.2); 
            transition: all 0.3s;
            cursor: pointer;
        }
        .system-card:hover { 
            border-color: rgba(59, 130, 246, 0.6);
            transform: translateY(-2px);
        }
        /* Custom dynamic value colors for clarity */
        .value-critical { color: #ef4444; font-weight: 700; }
        .value-warning { color: #f59e0b; font-weight: 700; }
        .value-optimal { color: #10b981; font-weight: 700; }
        
        .badge-critical { background: #dc2626; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-warning { background: #f59e0b; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .badge-optimal { background: #10b981; color: white; padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
        .marker-row { transition: all 0.2s; }
        .marker-row:hover { background: rgba(59, 130, 246, 0.1); }
        
        /* Data Lake Specific Styling */
        .primary-row { background-color: #1f2937; border-left: 4px solid #3b82f6; } /* Tailwind blue-500 border on primary rows */
        .primary-row:hover { background-color: #374151; } /* Darker slate on hover */
        
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0, 0, 0, 0.8); 
            z-index: 1000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            backdrop-filter: blur(5px);
        }
        /* AI Report Specific Styling */
        .ai-report-container {
            background-color: #111827;
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            border: 1px solid #1e293b;
        }
        .ai-report-header {
            background-color: #0f172a; /* Deeper header contrast */
            padding: 24px;
            border-radius: 8px 8px 0 0;
            border-bottom: 2px solid #3b82f6;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .report-section {
            padding: 20px 24px;
            border-bottom: 1px solid #1e293b;
        }
        .report-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #94a3b8; /* Slate 400 */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .insight-card {
            background-color: #1e293b;
            border-left: 4px solid #3b82f6;
            padding: 16px;
            border-radius: 6px;
        }
        .insight-card .title {
            color: #4f46e5;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useCallback, useEffect } = React; 

        // Define primary systems and their marker categories
        const systemCategories = {
            metabolic: { name: "Metabolic Health", icon: "‚ö°" },
            lipid: { name: "Lipid Panel", icon: "üíß" },
            inflammation: { name: "Inflammation", icon: "üî•" },
            liver: { name: "Liver Function", icon: "ü´Ä" },
            kidney: { name: "Kidney", icon: "üî¨" },
            vitamins: { name: "Vitamins & Minerals", icon: "üíä" },
            hormonal: { name: "Hormonal Balance", icon: "‚öñÔ∏è" },
            gut: { name: "Gut Microbiome", icon: "ü¶†" },
            clinical: { name: "General/Clinical", icon: "üìä" }
        };

        const EXTERNAL_LOGGING_ENDPOINT = "https://formspree.io/f/mzznwlnz"; 

        // --- UTILITY FUNCTIONS ---
        const getStatusClasses = (status) => {
            const statusLower = (status || 'optimal').toLowerCase();
            return {
                valueClass: `value-${statusLower}`,
                badgeClass: `badge-${statusLower}`
            };
        };

        // Generate 253 markers (27 primary + 226 secondary)
        const generateFullMarkers = (baseMarkers) => {
            const fullMarkers = { ...baseMarkers };

            const categoryMaps = {
                'metabolic': ['lactate', 'pyruvate', 'ketones', 'adiponectin', 'leptin', 'glucagon'],
                'lipid': ['vldl', 'non_hdl', 'apob', 'lp_a', 'ldl_particle_number', 'omega3_index'],
                'inflammation': ['il1b', 'il8', 'il10', 'ifn_gamma', 'mcp1', 'fibrinogen'],
                'liver': ['alp', 'bilirubin_total', 'albumin', 'ldh', 'bile_acids', 'hepcidin'],
                'kidney': ['bun', 'cystatin_c', 'urea', 'sodium', 'potassium', 'calcium'],
                'vitamins': ['vitamin_a', 'vitamin_e', 'vitamin_k', 'vitamin_c', 'zinc', 'selenium'],
                'hormonal': ['free_testosterone', 'shbg', 'dhea', 'estradiol', 'progesterone', 'acth'],
                'gut': ['elastase', 'secretory_iga', 'histamine', 'tmao', 'butyrate', 'bifidobacterium'],
                'clinical': ['hemoglobin', 'hematocrit', 'mcv', 'platelets', 'neutrophils', 'bp_diastolic']
            };

            const statuses = ['optimal', 'warning', 'critical'];

            // Assign categories and generate markers
            for (let categoryKey in categoryMaps) {
                categoryMaps[categoryKey].forEach(markerName => {
                    const randomStatus = statuses[Math.floor(Math.random() * statuses.length)];
                    const randomValue = (Math.random() * 100).toFixed(1);
                    fullMarkers[markerName] = {
                        value: randomValue,
                        ref: '10-90',
                        status: randomStatus,
                        category: categoryKey,
                        unit: 'units',
                        isPrimary: false
                    };
                });
            }

            // Fill up remaining secondary markers randomly to hit 253
            const secondaryCount = 253 - Object.keys(fullMarkers).length;
            for (let i = 0; i < secondaryCount; i++) {
                const randomCategoryKey = Object.keys(systemCategories)[Math.floor(Math.random() * Object.keys(systemCategories).length)];
                fullMarkers[`sec_marker_${i + 1}`] = {
                    value: (Math.random() * 100).toFixed(1),
                    ref: '10-90',
                    status: statuses[Math.floor(Math.random() * statuses.length)],
                    category: randomCategoryKey,
                    unit: 'units',
                    isPrimary: false
                };
            }

            // Mark primary markers
            Object.keys(baseMarkers).forEach(key => {
                if (fullMarkers[key]) {
                    fullMarkers[key].isPrimary = true;
                    fullMarkers[key].category = baseMarkers[key].category; // Ensure primary marker category is retained
                }
            });

            return fullMarkers;
        };

        const demoPatients = [
            {
                id: 1,
                name: "Patient 1 (High Risk)",
                age: 45,
                gender: "Male",
                scenario: "Pre-diabetic with metabolic syndrome",
                biologicalAge: 52,
                systemicRisk: 68,
                futureReadiness: 42,
                ndi: 3.2,
                met: 2.1,
                convergence: "MODERATE: METABOLIC-INFLAMMATORY COUPLING",
                markers: {
                    glucose: { value: 125, ref: "70-100", status: "critical", category: "metabolic", role: "Fasting Glucose", unit: "mg/dL" },
                    hba1c: { value: 6.8, ref: "<5.7", status: "critical", category: "metabolic", role: "Hemoglobin A1c", unit: "%" },
                    insulin: { value: 18.5, ref: "2-20", status: "warning", category: "metabolic", role: "Fasting Insulin", unit: "ŒºIU/mL" },
                    homa_ir: { value: 4.9, ref: "<2.5", status: "critical", category: "metabolic", role: "HOMA-IR Score", unit: "index" },
                    triglycerides: { value: 220, ref: "<150", status: "critical", category: "lipid", role: "Triglycerides", unit: "mg/dL" },
                    hdl: { value: 38, ref: ">40", status: "warning", category: "lipid", role: "HDL Cholesterol", unit: "mg/dL" },
                    ldl: { value: 128, ref: "<100", status: "critical", category: "lipid", role: "LDL Cholesterol", unit: "mg/dL" },
                    total_chol: { value: 245, ref: "<200", status: "critical", category: "lipid", role: "Total Cholesterol", unit: "mg/dL" },
                    crp: { value: 4.2, ref: "<3.0", status: "critical", category: "inflammation", role: "C-Reactive Protein", unit: "mg/L" },
                    il6: { value: 6.2, ref: "<3.0", status: "critical", category: "inflammation", role: "Interleukin-6", unit: "pg/mL" },
                    tnf_alpha: { value: 15.8, ref: "<8.1", status: "critical", category: "inflammation", role: "TNF-alpha", unit: "pg/mL" },
                    alt: { value: 65, ref: "7-56", status: "warning", category: "liver", role: "ALT", unit: "U/L" },
                    ast: { value: 52, ref: "10-40", status: "warning", category: "liver", role: "AST", unit: "U/L" },
                    ggt: { value: 78, ref: "<50", status: "critical", category: "liver", role: "GGT", unit: "U/L" },
                    creatinine: { value: 1.3, ref: "0.7-1.3", status: "optimal", category: "kidney", role: "Creatinine", unit: "mg/dL" },
                    egfr: { value: 72, ref: ">90", status: "warning", category: "kidney", role: "eGFR", unit: "mL/min" },
                    uric_acid: { value: 7.8, ref: "3.5-7.2", status: "warning", category: "kidney", role: "Uric Acid", unit: "mg/dL" },
                    vitamin_d: { value: 22, ref: "30-100", status: "critical", category: "vitamins", role: "Vitamin D", unit: "ng/mL" },
                    vitamin_b12: { value: 320, ref: "200-900", status: "optimal", category: "vitamins", role: "Vitamin B12", unit: "pg/mL" },
                    folate: { value: 6.5, ref: "3-17", status: "optimal", category: "vitamins", role: "Folate", unit: "ng/mL" },
                    testosterone: { value: 285, ref: "300-1000", status: "warning", category: "hormonal", role: "Testosterone", unit: "ng/dL" },
                    cortisol: { value: 22, ref: "6-23", status: "optimal", category: "hormonal", role: "Cortisol", unit: "Œºg/dL" },
                    tsh: { value: 4.8, ref: "0.4-4.0", status: "warning", category: "hormonal", role: "TSH", unit: "mIU/L" },
                    zonulin: { value: 95, ref: "<30", status: "critical", category: "gut", role: "Zonulin", unit: "ng/mL" },
                    calprotectin: { value: 185, ref: "<50", status: "critical", category: "gut", role: "Calprotectin", unit: "Œºg/g" },
                    bmi: { value: 31.2, ref: "18.5-24.9", status: "critical", category: "clinical", role: "BMI", unit: "kg/m¬≤" },
                    bp_systolic: { value: 145, ref: "<120", status: "critical", category: "clinical", role: "Blood Pressure Systolic", unit: "mmHg" }
                }
            },
            {
                id: 2,
                name: "Patient 2 (Optimal)",
                age: 32,
                gender: "Female",
                scenario: "Optimal health - wellness enthusiast",
                biologicalAge: 28,
                systemicRisk: 15,
                futureReadiness: 92,
                ndi: 0.8,
                met: 5.2,
                convergence: "OPTIMAL: ALL SYSTEMS SYNCHRONIZED",
                markers: {
                    glucose: { value: 85, ref: "70-100", status: "optimal", category: "metabolic", role: "Fasting Glucose", unit: "mg/dL" },
                    hba1c: { value: 5.1, ref: "<5.7", status: "optimal", category: "metabolic", role: "Hemoglobin A1c", unit: "%" },
                    insulin: { value: 8, ref: "2-20", status: "optimal", category: "metabolic", role: "Fasting Insulin", unit: "ŒºIU/mL" },
                    homa_ir: { value: 1.7, ref: "<2.5", status: "optimal", category: "metabolic", role: "HOMA-IR Score", unit: "index" },
                    triglycerides: { value: 95, ref: "<150", status: "optimal", category: "lipid", role: "Triglycerides", unit: "mg/dL" },
                    hdl: { value: 65, ref: ">40", status: "optimal", category: "lipid", role: "HDL Cholesterol", unit: "mg/dL" },
                    ldl: { value: 92, ref: "<100", status: "optimal", category: "lipid", role: "LDL Cholesterol", unit: "mg/dL" },
                    total_chol: { value: 178, ref: "<200", status: "optimal", category: "lipid", role: "Total Cholesterol", unit: "mg/dL" },
                    crp: { value: 1.2, ref: "<3.0", status: "optimal", category: "inflammation", role: "C-Reactive Protein", unit: "mg/L" },
                    il6: { value: 1.8, ref: "<3.0", status: "optimal", category: "inflammation", role: "Interleukin-6", unit: "pg/mL" },
                    tnf_alpha: { value: 5.2, ref: "<8.1", status: "optimal", category: "inflammation", role: "TNF-alpha", unit: "pg/mL" },
                    alt: { value: 28, ref: "7-56", status: "optimal", category: "liver", role: "ALT", unit: "U/L" },
                    ast: { value: 26, ref: "10-40", status: "optimal", category: "liver", role: "AST", unit: "U/L" },
                    ggt: { value: 22, ref: "<50", status: "optimal", category: "liver", role: "GGT", unit: "U/L" },
                    creatinine: { value: 0.9, ref: "0.7-1.3", status: "optimal", category: "kidney", role: "Creatinine", unit: "mg/dL" },
                    egfr: { value: 98, ref: ">90", status: "optimal", category: "kidney", role: "eGFR", unit: "mL/min" },
                    uric_acid: { value: 4.8, ref: "3.5-7.2", status: "optimal", category: "kidney", role: "Uric Acid", unit: "mg/dL" },
                    vitamin_d: { value: 48, ref: "30-100", status: "optimal", category: "vitamins", role: "Vitamin D", unit: "ng/mL" },
                    vitamin_b12: { value: 520, ref: "200-900", status: "optimal", category: "vitamins", role: "Vitamin B12", unit: "pg/mL" },
                    folate: { value: 9.2, ref: "3-17", status: "optimal", category: "vitamins", role: "Folate", unit: "ng/mL" },
                    testosterone: { value: 380, ref: "300-1000", status: "optimal", category: "hormonal", role: "Testosterone", unit: "ng/dL" },
                    cortisol: { value: 14, ref: "6-23", status: "optimal", category: "hormonal", role: "Cortisol", unit: "Œºg/dL" },
                    tsh: { value: 2.1, ref: "0.4-4.0", status: "optimal", category: "hormonal", role: "TSH", unit: "mIU/L" },
                    zonulin: { value: 25, ref: "<30", status: "optimal", category: "gut", role: "Zonulin", unit: "ng/mL" },
                    calprotectin: { value: 35, ref: "<50", status: "optimal", category: "gut", role: "Calprotectin", unit: "Œºg/g" },
                    bmi: { value: 22.5, ref: "18.5-24.9", status: "optimal", category: "clinical", role: "BMI", unit: "kg/m¬≤" },
                    bp_systolic: { value: 112, ref: "<120", status: "optimal", category: "clinical", role: "Blood Pressure Systolic", unit: "mmHg" }
                }
            },
            {
                id: 3,
                name: "Patient 3 (Critical)",
                age: 58,
                gender: "Male",
                scenario: "Critical multi-system failure",
                biologicalAge: 72,
                systemicRisk: 94,
                futureReadiness: 12,
                ndi: 8.7,
                met: 0.9,
                convergence: "CATASTROPHIC: METABOLIC-INFLAMMATORY-CARDIO TRIAD FAILURE",
                markers: {
                    glucose: { value: 185, ref: "70-100", status: "critical", category: "metabolic", role: "Fasting Glucose", unit: "mg/dL" },
                    hba1c: { value: 8.9, ref: "<5.7", status: "critical", category: "metabolic", role: "Hemoglobin A1c", unit: "%" },
                    insulin: { value: 32, ref: "2-20", status: "critical", category: "metabolic", role: "Fasting Insulin", unit: "ŒºIU/mL" },
                    homa_ir: { value: 14.5, ref: "<2.5", status: "critical", category: "metabolic", role: "HOMA-IR Score", unit: "index" },
                    triglycerides: { value: 385, ref: "<150", status: "critical", category: "lipid", role: "Triglycerides", unit: "mg/dL" },
                    hdl: { value: 28, ref: ">40", status: "critical", category: "lipid", role: "HDL Cholesterol", unit: "mg/dL" },
                    ldl: { value: 198, ref: "<100", status: "critical", category: "lipid", role: "LDL Cholesterol", unit: "mg/dL" },
                    total_chol: { value: 312, ref: "<200", status: "critical", category: "lipid", role: "Total Cholesterol", unit: "mg/dL" },
                    crp: { value: 12.8, ref: "<3.0", status: "critical", category: "inflammation", role: "C-Reactive Protein", unit: "mg/L" },
                    il6: { value: 9.2, ref: "<3.0", status: "critical", category: "inflammation", role: "Interleukin-6", unit: "pg/mL" },
                    tnf_alpha: { value: 22.0, ref: "<8.1", status: "critical", category: "inflammation", role: "TNF-alpha", unit: "pg/mL" },
                    alt: { value: 92, ref: "7-56", status: "critical", category: "liver", role: "ALT", unit: "U/L" },
                    ast: { value: 78, ref: "10-40", status: "critical", category: "liver", role: "AST", unit: "U/L" },
                    ggt: { value: 125, ref: "<50", status: "critical", category: "liver", role: "GGT", unit: "U/L" },
                    creatinine: { value: 1.8, ref: "0.7-1.3", status: "critical", category: "kidney", role: "Creatinine", unit: "mg/dL" },
                    egfr: { value: 52, ref: ">90", status: "critical", category: "kidney", role: "eGFR", unit: "mL/min" },
                    uric_acid: { value: 9.8, ref: "3.5-7.2", status: "critical", category: "kidney", role: "Uric Acid", unit: "mg/dL" },
                    vitamin_d: { value: 12, ref: "30-100", status: "critical", category: "vitamins", role: "Vitamin D", unit: "ng/mL" },
                    vitamin_b12: { value: 180, ref: "200-900", status: "warning", category: "vitamins", role: "Vitamin B12", unit: "pg/mL" },
                    folate: { value: 2.8, ref: "3-17", status: "warning", category: "vitamins", role: "Folate", unit: "ng/mL" },
                    testosterone: { value: 220, ref: "300-1000", status: "critical", category: "hormonal", role: "Testosterone", unit: "ng/dL" },
                    cortisol: { value: 28, ref: "6-23", status: "critical", category: "hormonal", role: "Cortisol", unit: "Œºg/dL" },
                    tsh: { value: 6.8, ref: "0.4-4.0", status: "critical", category: "hormonal", role: "TSH", unit: "mIU/L" },
                    zonulin: { value: 145, ref: "<30", status: "critical", category: "gut", role: "Zonulin", unit: "ng/mL" },
                    calprotectin: { value: 285, ref: "<50", status: "critical", category: "gut", role: "Calprotectin", unit: "Œºg/g" },
                    bmi: { value: 36.8, ref: "18.5-24.9", status: "critical", category: "clinical", role: "BMI", unit: "kg/m¬≤" },
                    bp_systolic: { value: 168, ref: "<120", status: "critical", category: "clinical", role: "Blood Pressure Systolic", unit: "mmHg" }
                }
            }
        ];

        // Process data to include all 253 markers
        demoPatients.forEach(patient => {
            patient.fullMarkers = generateFullMarkers(patient.markers);
        });
        
        // --- COMPONENTS ---

        const StatusBadge = ({ status }) => {
            const { badgeClass } = getStatusClasses(status);
            return <span className={badgeClass}>{status.toUpperCase()}</span>;
        };
        
        // Helper to generate a simulated detailed report
        const getAIReport = (patient, getSystemStatsFn) => { 
            const m = patient.markers;

            const stats = {
                metabolic: getSystemStatsFn('metabolic', true, patient).markers,
                totalMarkers: Object.keys(patient.fullMarkers).length
            };
            
            // Analyze ALL 253 markers for the integrity summary blob
            const allMarkers = Object.entries(patient.fullMarkers).map(([_, m]) => m.status);
            const totalCritical = allMarkers.filter(s => s === 'critical').length;
            const totalWarning = allMarkers.filter(s => s === 'warning').length;
            const totalOptimal = allMarkers.filter(s => s === 'optimal').length;

            const primaryConcerns = []; 

            // --- Dynamic Status Check Helpers ---
            const getStatusText = (marker) => marker.status.toUpperCase();
            const getRamadanAdvice = (marker) => {
                if (marker.status === 'critical') return `**URGENT:** Endocrinology consultation is mandatory before fasting. Strict medical supervision required.`;
                if (marker.status === 'warning') return `**ADVISORY:** Monitor closely, optimize hydration and diet to mitigate risk during fasting periods.`;
                return `**SAFE:** Maintain current optimized pre-fasting diet and hydration protocols.`;
            };
            
            // --- AI Report Content Logic (Ensures dynamic patient data) ---
            
            const isOptimalPatient = patient.systemicRisk < 30; // Define Optimal threshold
            const hba1cStatus = getStatusText(m.hba1c);
            const ldlStatus = getStatusText(m.ldl);
            const crpStatus = getStatusText(m.crp);
            const vdStatus = getStatusText(m.vitamin_d);
            
            const generalRiskLevel = isOptimalPatient ? 'an Optimal Risk' : 'a High-Risk Metabolic Storm';

            const criticalFindings = [];

            if (!isOptimalPatient) {
                criticalFindings.push({
                    title: "1. GCC Metabolic Storm Detected",
                    status: m.homa_ir.status,
                    pattern: `**Pattern:** ${m.hba1c.role} (${m.hba1c.value}%) + ${m.insulin.role} (${m.insulin.value} ${m.insulin.unit}) + ${m.triglycerides.role} (${m.triglycerides.value} ${m.triglycerides.unit})`,
                    risk: `**Risk:** Pre-diabetic state with insulin resistance. **Status:** ${hba1cStatus} risk progression.`,
                    context: `**GCC Context:** This pattern is strongly linked to prevalent factors like high dietary glycemic load, sedentary lifestyle, and common genetic risk factors in the wider Arab population.`,
                    ramadan: `**üåô Ramadan Guidance:** ${getRamadanAdvice(m.glucose)}`
                });

                criticalFindings.push({
                    title: "2. Atherogenic Dyslipidemia & Cardiovascular Risk",
                    status: m.ldl.status,
                    pattern: `**Pattern:** ${m.triglycerides.role} (${m.triglycerides.value} ${m.triglycerides.unit}) + ${m.hdl.role} (${m.hdl.value} ${m.hdl.unit}) + ${m.ldl.role} (${m.ldl.value} ${m.ldl.unit})`,
                    risk: `**Risk:** ${ldlStatus} risk acceleration due to poor lipid clearance and low protective HDL.`,
                    context: `**GCC Context:** Low HDL-C is endemic in this population due to high carbohydrate/fat diets and low physical activity. Elevated atherogenic particles increase cardiovascular risk.`,
                    ramadan: `**üåô Ramadan Guidance:** Monitor strict fat consumption during Iftar to prevent hypertriglyceridemia flare-ups.`
                });
            }
            
            criticalFindings.push({
                title: "3. Paradoxical Vitamin D Deficiency",
                status: m.vitamin_d.status,
                pattern: `**Pattern:** ${m.vitamin_d.role} (${m.vitamin_d.value} ${m.vitamin_d.unit}) (Reference: ${m.vitamin_d.ref})`,
                risk: `**Risk:** Deficiency exacerbates insulin resistance, increases cardiovascular risk, and impairs immune function. **Status:** ${vdStatus}`,
                context: `**GCC Context:** Deficiency is widespread in Qatar (affecting 80%) due to indoor lifestyle, clothing coverage, and genetic factors affecting synthesis.`,
                ramadan: `**üåô Ramadan Guidance:** Strict supplementation schedule required. Compliance is key during intermittent eating windows.`
            });

            if (!isOptimalPatient) {
                criticalFindings.push({
                    title: "4. Chronic Systemic Inflammation",
                    status: m.crp.status,
                    pattern: `**Pattern:** ${m.crp.role} (${m.crp.value} ${m.crp.unit}) + ${m.uric_acid.role} (${m.uric_acid.value} ${m.uric_acid.unit})`,
                    risk: `**Risk:** Chronic inflammation with cardiovascular implications; suggests high oxidative stress. **Status:** ${crpStatus}`,
                    context: `**GCC Context:** Elevated markers correlate with high red meat consumption and low omega-3 intake typical in regional diets.`,
                    ramadan: `**üåô Ramadan Guidance:** Focus on increasing fiber and green leafy vegetables during Suhoor to manage inflammation and oxidative stress.`
                });
            }

            // --- Intervention Strategy (DYNAMIC) ---
            const interventionStrategy = isOptimalPatient 
                ? [
                    { title: "PHASE 1: MAINTENANCE & LONGEVITY", points: ["Maintain optimal metrics through balanced nutrition and consistent activity.", "Continue quarterly review of GCC pillars (Vit D, HOMA-IR) to preempt future risks."]},
                    { title: "PHASE 2: ENHANCEMENT PROTOCOL", points: ["Consider advanced longevity supplements (e.g., NMN, Resveratrol).", "Focus physical activity on resistance training to maximize muscle health."]}
                ]
                : [
                    { 
                        title: "PHASE 1: IMMEDIATE ACTIONS (Weeks 1-4)", 
                        points: [
                            "Metabolic Optimization: Metformin consideration. Adopt low-GI Mediterranean-Gulf hybrid diet (replace white rice, limit dates, increase lentils).",
                            "Vitamin D Restoration: High-dose supplementation (e.g., 50,000 IU weekly for 8 weeks). Target level: >40 ng/mL.",
                            "Physical Activity: Priority on indoor exercise (gym, mall walking), targeting 150 min/week."
                        ]
                    },
                    { 
                        title: "PHASE 2: RAMADAN-SPECIFIC GUIDANCE (If applicable)", 
                        points: [
                            "Endocrinology consultation mandatory. Optimize HbA1c to <6.5% before fasting.",
                            "Suhoor Strategy: Complex carbs, protein, and healthy fats (Oats, Eggs, Labneh).",
                            "Iftar Strategy: Start with 1-2 dates + water. Focus on grilled proteins, vegetable soups."
                        ]
                    },
                    { 
                        title: "PHASE 3: LONG-TERM OPTIMIZATION (Months 2-6)", 
                        points: [
                            "Lipid Management: Omega-3 supplementation (2-3g EPA/DHA daily). Increase local fish consumption.",
                            "Inflammation Reduction: Anti-inflammatory diet (increase turmeric/ginger). Stress and sleep optimization.",
                            "Hormonal: Address root causes of low-normal Testosterone before replacement."
                        ]
                    }
                ];

            // --- Final Prognosis (DYNAMIC) ---
            const finalPrognosis = isOptimalPatient ?
                `The overall prognosis is excellent. Continued adherence to current lifestyle protocols suggests a high probability of preserving optimal systemic function and maintaining a biological age below chronological age.`
                :
                `**Target Outcomes (6 months):** HbA1c: <5.7%, HOMA-IR: <2.5, Vitamin D: >40 ng/mL, hs-CRP: <1.0 mg/L.
                
                With aggressive, culturally-aware intervention, this patient has an 80% probability of reversing the pre-diabetic state and significantly reducing cardiovascular risk. Without intervention, this patient faces a 65% risk of Type 2 Diabetes and 3.5x increased cardiovascular risk within 5 years.
            `;


            return {
                integrityStats: {
                    total: totalCritical,
                    warning: totalWarning,
                    optimal: totalOptimal
                },
                executiveSummary: isOptimalPatient ?
                    `This ${patient.age}-year-old ${patient.gender} maintains an exceptional **Optimal Health Profile**. Biomarkers demonstrate high metabolic efficiency and minimal systemic inflammation, confirming robust resilience and a low risk for chronic disease development.`
                    :
                    `This ${patient.age}-year-old ${patient.gender} presents with a metabolic profile consistent with a **High-Risk Metabolic Storm** pattern, common in specific high-risk demographics globally. The convergence of pre-diabetic markers, dyslipidemia, and chronic inflammation requires immediate intervention tailored to regional lifestyle and metabolic factors.`,
                criticalFindings: criticalFindings.filter(f => f.status !== 'optimal'), // Only show non-optimal findings
                interventionStrategy: interventionStrategy,
                prognosis: finalPrognosis
            };
        };


        const DeepDiveModal = ({ data, onClose }) => {
            const { valueClass } = getStatusClasses(data.status);
            
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div 
                        className="bg-slate-800 p-8 rounded-xl w-full max-w-4xl shadow-2xl border border-blue-500 max-h-[80vh] overflow-y-auto"
                        onClick={e => e.stopPropagation()}
                    >
                        <div className="flex justify-between items-start border-b border-slate-600 pb-3 mb-4">
                            <div>
                                <h3 className="text-3xl font-bold text-blue-400">{data.icon} {data.title}</h3>
                                <p className="text-slate-400 text-sm mt-1">{data.subtitle}</p>
                            </div>
                            <button onClick={onClose} className="text-2xl text-slate-400 hover:text-white">&times;</button>
                        </div>
                        
                        {/* 1. STATUS and VALUE/REF RANGE SUMMARY (CLEANED - Shows only necessary data) */}
                        <div className="mb-4">
                            {/* STATUS ONLY */}
                            <p className={`text-xl font-bold ${valueClass} mb-2`}>
                                Status: {data.status.toUpperCase()}
                            </p>
                            
                            {/* VALUE AND REFERENCE RANGE (if available from KPI/Pillar click) */}
                            {data.value && data.units && data.ref && (
                                <p className="text-slate-300 text-sm font-mono">
                                    Value: <span className={valueClass}>{data.value} {data.units}</span> (Ref: {data.ref})
                                </p>
                            )}

                            {/* 2. DESCRIPTION (Pillar Context / KPI Description) */}
                            <p className="text-slate-300 text-sm mt-3">{data.description}</p>
                        </div>

                        {data.markers && data.markers.length > 0 && (
                            <div className="mt-6">
                                <h4 className="text-lg font-bold mb-3 border-b border-slate-700 pb-2">Constituent Markers:</h4>
                                <div className="space-y-2">
                                    {data.markers.map((marker, index) => {
                                        const { valueClass } = getStatusClasses(marker.status);
                                        return (
                                            <div key={index} className="flex justify-between items-center p-3 bg-slate-900 rounded marker-row">
                                                <span className="font-semibold text-slate-300 w-2/5">{marker.name}</span>
                                                <div className="w-1/5 text-center">
                                                    <span className={`font-bold ${valueClass}`}>
                                                        {marker.value} {marker.unit}
                                                    </span>
                                                </div>
                                                <span className="text-slate-400 w-1/5 text-center text-sm">{marker.ref}</span>
                                                <span className="w-1/5 text-right">
                                                    <StatusBadge status={marker.status} />
                                                </span>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        <div className="mt-6 text-right">
                            <button onClick={onClose} className="px-6 py-2 bg-blue-600 rounded-lg font-semibold hover:bg-blue-500">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const GCCHealthPillars = ({ selectedPatient, onPillarClick }) => {
            const m = selectedPatient.markers;

            // Helper function to provide rich contextual description for GCC pillars
            const getPillarContext = (markerKey, m) => {
                const marker = m[markerKey];
                if (!marker) return "No specific context available for this marker.";
                const value = marker.value;
                const unit = marker.unit;
                const status = marker.status;
                const ref = marker.ref;

                switch (markerKey) {
                    case 'bmi':
                        return `BMI at ${value} ${unit} (Reference: ${ref}, Status: ${status.toUpperCase()}). This is a critical risk factor for metabolic syndrome, strongly linked to sedentary lifestyle patterns prevalent in the GCC region.`;
                    case 'homa_ir':
                        return `The HOMA-IR score of ${value} (Reference: ${ref}, Status: ${status.toUpperCase()}) confirms insulin sensitivity status. This is the primary metabolic driver of chronic disease, directly linking to the regional challenge of Type 2 Diabetes (T2D).`;
                    case 'uric_acid':
                        return `Uric Acid at ${value} ${unit} (Reference: ${ref}, Status: ${status.toUpperCase()}). This is often tied to high metabolic load and kidney strain, common findings associated with high protein diets and metabolic syndrome in the GCC demographic.`;
                    case 'vitamin_d':
                        return `Vitamin D is at ${value} ${unit} (Reference: ${ref}, Status: ${status.toUpperCase()}). This paradoxical deficiency, despite the sunny climate, severely compromises immune function and exacerbates metabolic risk factors endemic to the GCC.`;
                    default:
                        return `${marker.role} value is ${value} ${unit} (Reference: ${ref}).`;
                }
            }


            const pillars = [
                { name: "BMI/Obesity", markerKey: 'bmi', icon: '‚öñÔ∏è', title: 'BMI/Obesity Status', subtitle: 'A key regional health challenge indicator.' },
                { name: "HOMA-IR Score", markerKey: 'homa_ir', icon: 'üíâ', title: 'HOMA-IR Status', subtitle: 'Primary measure of insulin sensitivity.' },
                { name: "Uric Acid", markerKey: 'uric_acid', icon: 'ü©∏', title: 'Uric Acid Level', subtitle: 'Metabolic waste and kidney stress indicator.' },
                { name: "Vitamin D", markerKey: 'vitamin_d', icon: '‚òÄÔ∏è', title: 'Vitamin D Status', subtitle: 'Common deficiency impacting immunity and bone health.' }
            ];

            return (
                <div className="space-y-4">
                    <h3 className="text-2xl font-bold text-blue-400 border-b border-slate-700 pb-2">GCC Health Pillars</h3>
                    <div className="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        {pillars.map(pillar => {
                            const marker = selectedPatient.markers[pillar.markerKey];
                            if (!marker) return null;
                            const { valueClass } = getStatusClasses(marker.status);

                            // Get the list of Primary Markers only for this category for the modal breakdown
                            const primaryMarkersInSystem = Object.entries(selectedPatient.fullMarkers)
                                .filter(([_, m]) => m.isPrimary && m.category === marker.category)
                                .map(([key, m]) => ({
                                    name: m.role || key.toUpperCase().replace(/_/g, ' '),
                                    value: m.value,
                                    unit: m.unit,
                                    ref: m.ref,
                                    status: m.status
                                }));

                            return (
                                <div 
                                    key={pillar.markerKey} 
                                    className="kpi-card p-4 rounded-xl shadow-lg hover:shadow-cyan-500/50"
                                    onClick={() => onPillarClick({
                                        title: pillar.title,
                                        icon: pillar.icon,
                                        subtitle: pillar.subtitle,
                                        status: marker.status,
                                        description: getPillarContext(pillar.markerKey, m), // USE ENRICHED CONTEXT
                                        value: marker.value, // Pass value explicitly
                                        units: marker.unit, // Pass unit explicitly
                                        ref: marker.ref, // Pass ref explicitly
                                        markers: primaryMarkersInSystem
                                    })}
                                >
                                    <div className="text-slate-400 text-sm flex items-center gap-2 mb-1">
                                        <span className="text-xl">{pillar.icon}</span> {pillar.name}
                                    </div>
                                    <div className={`text-3xl font-extrabold ${valueClass} mt-1`}>
                                        {marker.value} <span className="text-sm font-medium text-slate-400">{marker.unit}</span>
                                    </div>
                                    <StatusBadge status={marker.status} />
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };
        
        const AIReportPrimaryMarkerTable = ({ selectedPatient }) => {
            const primaryMarkers = Object.entries(selectedPatient.markers)
                .map(([key, m]) => ({
                    name: m.role || key.toUpperCase().replace(/_/g, ' '),
                    value: m.value,
                    unit: m.unit,
                    ref: m.ref,
                    status: m.status,
                    category: m.category,
                }));

            return (
                <div className="mt-6 bg-slate-700 p-4 rounded-lg border border-slate-600 shadow-inner">
                    <h3 className="font-bold text-xl text-white mb-3 flex items-center">
                        <span className="text-2xl mr-2">üî¨</span> Core 27 Primary Marker Snapshot
                    </h3>
                    <div className="overflow-x-auto rounded-lg border border-slate-600 max-h-[40vh] scrollbar-hide">
                        <table className="min-w-full divide-y divide-slate-600 text-sm">
                            <thead>
                                <tr className="text-xs font-medium uppercase tracking-wider text-slate-400 bg-slate-900 sticky top-0 z-10">
                                    <th className="px-3 py-2 text-left w-1/4">Marker</th>
                                    <th className="px-3 py-2 text-left w-1/4">System</th>
                                    <th className="px-3 py-2 text-center w-1/4">Value (Range)</th>
                                    <th className="px-3 py-2 text-center w-1/4">Status</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-800">
                                {primaryMarkers.map((marker, index) => {
                                    const { valueClass } = getStatusClasses(marker.status);
                                    return (
                                        <tr key={index} className="bg-slate-800 hover:bg-slate-700">
                                            <td className="px-3 py-2 font-semibold text-slate-200">{marker.name}</td>
                                            <td className="px-3 py-2 text-slate-400">{systemCategories[marker.category]?.name || marker.category}</td>
                                            <td className="px-3 py-2 text-center">
                                                <span className={valueClass}>
                                                    {marker.value} {marker.unit}
                                                </span>
                                                <span className="text-slate-500 block text-xs">({marker.ref})</span>
                                            </td>
                                            <td className="px-3 py-2 text-center">
                                                <StatusBadge status={marker.status} />
                                            </td>
                                        </tr>
                                    );
                                })}
                            </tbody>
                        </table>
                    </div>
                </div>
            );
        };
        
        const ReportCard = ({ icon, title, status, children, className = '', colorClass = 'border-blue-500' }) => (
            <div className={`insight-card ${className} border-l-4 ${colorClass} p-4 rounded-lg shadow-md`}>
                <div className="flex justify-between items-start">
                    <h4 className="title text-base mb-2 flex items-center text-white">
                        <span className="text-2xl mr-2">{icon}</span> {title}
                    </h4>
                    <StatusBadge status={status || 'optimal'} />
                </div>
                <div className="text-sm text-slate-300 space-y-2">
                    {children}
                </div>
            </div>
        );

        
        // --- NEW: AI GENERATION SCREEN COMPONENT ---
        const AIGenerationScreen = ({ onComplete }) => {
            const PIPELINE_STEPS = [
                { id: 1, name: "Data Acquisition & Validation", message: "Ingesting 253 biomarkers and performing integrity check..." },
                { id: 2, name: "Logical Mashery: Feature Extraction", message: "Extracting 27 core primary risk indicators." },
                { id: 3, name: "Pattern Matching & Risk Calculation", message: "Calculating BioAge, NDI, MET, and Systemic Risk Score." },
                { id: 4, name: "Gemini Synthesis & Narrative Generation", message: "Synthesizing contextual findings and generating actionable recommendations." },
                { id: 5, name: "Report Finalization", message: "Compiling final PDF and HTML view for delivery." }
            ];

            const [currentStep, setCurrentStep] = useState(0);
            const [progress, setProgress] = useState(0);

            useEffect(() => {
                if (currentStep < PIPELINE_STEPS.length) {
                    // Start of new step
                    setProgress(0);
                    const stepDuration = 700; 

                    const interval = setInterval(() => {
                        setProgress(prev => {
                            if (prev >= 100) {
                                clearInterval(interval);
                                // Move to next step
                                setCurrentStep(prevStep => prevStep + 1);
                                return 100;
                            }
                            return prev + (100 / (stepDuration / 50)); // smooth increment
                        });
                    }, 50);

                    return () => clearInterval(interval);
                } else {
                    // Pipeline Complete
                    setTimeout(onComplete, 500); 
                }
            }, [currentStep, onComplete]);


            const currentMessage = currentStep < PIPELINE_STEPS.length 
                ? PIPELINE_STEPS[currentStep].message 
                : "Analysis Complete. Rendering Final Report...";

            return (
                <div className="fixed inset-0 bg-slate-900 z-[1100] flex justify-center items-center p-8">
                    <div className="w-full max-w-xl bg-slate-800 p-8 rounded-xl shadow-2xl border border-blue-500">
                        <h3 className="text-4xl font-extrabold text-cyan-400 mb-6 flex items-center">
                            <span className="text-5xl mr-3">üöÄ</span> AI Report Generation
                        </h3>
                        
                        {PIPELINE_STEPS.map((step, index) => (
                            <div key={step.id} className="mb-4">
                                <div className={`font-semibold ${index <= currentStep ? 'text-white' : 'text-slate-600'}`}>
                                    {index < currentStep ? '‚úÖ' : (index === currentStep ? '‚è≥' : '‚óªÔ∏è')} {step.name}
                                </div>
                                {index === currentStep && (
                                    <div className="mt-1">
                                        <div className="text-sm text-blue-400 mb-1">{currentMessage}</div>
                                        <div className="h-2 bg-slate-700 rounded-full overflow-hidden">
                                            <div 
                                                className="h-full bg-blue-500 transition-all duration-100 ease-linear"
                                                style={{ width: `${progress}%` }}
                                            ></div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        ))}

                         {currentStep >= PIPELINE_STEPS.length && (
                             <div className="text-center mt-6">
                                <p className="text-green-400 text-xl font-bold">REPORT READY!</p>
                             </div>
                         )}
                    </div>
                </div>
            );
        };
        
        // --- ACCESS GATE MODAL ---
        const AccessGateModal = ({ setIsGated }) => {
            const [email, setEmail] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [message, setMessage] = useState('');
        
            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsLoading(true);
                setMessage('');
        
                if (!email.includes('@') || email.length < 5) {
                    setMessage('Please enter a valid email address.');
                    setIsLoading(false);
                    return;
                }
        
                try {
                    // Simulate lead capture for POC structure
                    const response = await fetch(EXTERNAL_LOGGING_ENDPOINT, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, product: 'Burak Data Co-Pilot POC', access_request: new Date().toISOString() })
                    });
        
                    if (response.ok) {
                        localStorage.setItem('burak_access', 'granted');
                        setMessage('Access granted! Loading dashboard...');
                        setTimeout(() => setIsGated(false), 1000);
                    } else {
                        setMessage('Access logging failed. Granting temporary access.');
                        localStorage.setItem('burak_access', 'granted');
                        setTimeout(() => setIsGated(false), 1000);
                    }
        
                } catch (error) {
                    console.error("Form submission error:", error);
                    setMessage('Error connecting to logging service. Granting temporary access.');
                    localStorage.setItem('burak_access', 'granted');
                    setTimeout(() => setIsGated(false), 1000);
                } finally {
                    setIsLoading(false);
                }
            };
        
            return (
                <div className="fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center">
                    <div className="bg-gray-900 border-2 border-sky-600 p-8 rounded-xl w-full max-w-lg shadow-[0_0_50px_rgba(6,182,212,0.8)] transform transition-all duration-300">
                        <div className="text-center">
                            <span className="text-6xl mb-4 block glow-text">üîí</span>
                            <h3 className="text-3xl font-extrabold text-white mb-2">Access Required: Production POC</h3>
                            <p className="text-gray-400 mb-6">
                                This is a restricted research artifact. Please enter your email to access the Burak Co-Pilot dashboard and log your interest.
                            </p>
                        </div>
        
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input
                                type="email"
                                placeholder="Your Professional Email Address"
                                value={email}
                                onChange={(e) => setEmail(e.target.value)}
                                required
                                className="w-full p-3 rounded-lg bg-gray-800 border border-sky-600/50 text-white placeholder-gray-500 focus:ring-sky-500 focus:border-sky-500"
                                disabled={isLoading}
                            />
                            <button
                                type="submit"
                                disabled={isLoading}
                                className="w-full flex items-center justify-center px-6 py-3 border border-indigo-600 rounded-lg text-white font-semibold bg-indigo-700 hover:bg-indigo-600 transition-colors shadow-lg shadow-indigo-700/50 disabled:bg-gray-600 disabled:shadow-none"
                            >
                                {isLoading ? (
                                    <svg className="animate-spin h-5 w-5 mr-3 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle><path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                                ) : 'Grant Access'}
                            </button>
                        </form>
        
                        {message && (
                            <p className={`mt-4 text-center text-sm font-semibold ${message.includes('Error') || message.includes('failed') ? 'text-red-400' : 'text-emerald-400'}`}>
                                {message}
                            </p>
                        )}
                    </div>
                </div>
            );
        };


        function App() {
            const [selectedPatient, setSelectedPatient] = useState(demoPatients[0]);
            const [activeTab, setActiveTab] = useState('cockpit');
            const [searchTerm, setSearchTerm] = useState('');
            const [activeModalData, setActiveModalData] = useState(null); 
            const [isGeneratingReport, setIsGeneratingReport] = useState(false); // NEW STATE

            // Function to filter and aggregate markers by category
            const getSystemStats = useCallback((categoryKey, fullData = false, patient = selectedPatient) => {
                const markers = Object.entries(patient.fullMarkers)
                    .filter(([_, m]) => m.category === categoryKey);
                
                // For Cockpit stats, use only primary markers for accurate 27-marker breakdown
                const markersToCount = markers.filter(([_, m]) => m.isPrimary);
                
                const critical = markersToCount.filter(([_, m]) => m.status === 'critical').length;
                const warning = markersToCount.filter(([_, m]) => m.status === 'warning').length;
                const optimal = markersToCount.filter(([_, m]) => m.status === 'optimal').length;

                // For modal/data lake (if fullData is true), return all markers, otherwise just primary for count accuracy
                const markersForDisplay = fullData 
                    ? markers 
                    : markersToCount;

                const allMarkers = markersForDisplay.map(([name, marker]) => ({
                    name: marker.role || name.toUpperCase().replace(/_/g, ' '),
                    value: marker.value,
                    unit: marker.unit,
                    ref: marker.ref,
                    status: marker.status,
                    isPrimary: marker.isPrimary
                }));

                return { 
                    total: markersForDisplay.length, 
                    critical, 
                    warning, 
                    optimal, 
                    markers: allMarkers 
                };
            }, [selectedPatient]);


            // Memoized KPI data for the main dashboard view
            const kpiData = useMemo(() => {
                return [
                    { name: "Biological Age", value: selectedPatient.biologicalAge, units: "yrs", compare: selectedPatient.age, status: selectedPatient.biologicalAge > selectedPatient.age ? 'critical' : 'optimal', description: `Actual Age: ${selectedPatient.age}.` },
                    { name: "Systemic Risk", value: selectedPatient.systemicRisk, units: "%", compare: 40, status: selectedPatient.systemicRisk >= 70 ? 'critical' : selectedPatient.systemicRisk >= 40 ? 'warning' : 'optimal', description: `High risk profile for chronic disease.` },
                    { name: "Future Readiness", value: selectedPatient.futureReadiness, units: "%", compare: 70, status: selectedPatient.futureReadiness <= 40 ? 'critical' : selectedPatient.futureReadiness <= 70 ? 'warning' : 'optimal', description: `Measures metabolic adaptability and resilience.` },
                    { name: "Nutrient Depletion (NDI)", value: selectedPatient.ndi, units: "score", compare: 2.5, status: selectedPatient.ndi >= 4 ? 'critical' : selectedPatient.ndi >= 2 ? 'warning' : 'optimal', description: `Index of micronutrient deficiency impact.` },
                    { name: "Metabolic Trajectory (MET)", value: selectedPatient.met, units: "score", compare: 2.0, status: selectedPatient.met <= 1.0 ? 'critical' : selectedPatient.met <= 3.0 ? 'warning' : 'optimal', description: `Velocity of core risk markers over time.` },
                ].map(kpi => {
                    const { valueClass } = getStatusClasses(kpi.status);
                    return { ...kpi, valueClass }; // Attach value class here for render simplicity
                });
            }, [selectedPatient]);


            // --- DEEP DIVE HANDLERS ---
            const handleKpiClick = (kpi) => {
                // Determine a clearer description for the modal content
                let detailedDescription = "";

                if (kpi.name === "Biological Age") {
                    detailedDescription = `Your calculated biological age is ${kpi.value} ${kpi.units} (Actual Age: ${selectedPatient.age} yrs). This metric provides a synthetic measure of aging derived from epigenetic and metabolic markers. Status: **${kpi.status.toUpperCase()}**.`;
                } else if (kpi.name === "Systemic Risk") {
                    detailedDescription = `The Systemic Risk score is currently **${kpi.status.toUpperCase()}** at ${kpi.value}${kpi.units}. This score assesses the combined threat from chronic metabolic and inflammatory markers, indicating the urgency of intervention.`;
                } else if (kpi.name === "Metabolic Trajectory (MET)") {
                    const trend = kpi.value > 0 ? "an improving" : kpi.value < 0 ? "a worsening" : "a stable";
                    detailedDescription = `The Metabolic Trajectory score of ${kpi.value} indicates ${trend} trend in core risk markers (Glucose, HOMA-IR). This measures the velocity of metabolic health over time.`;
                } else {
                    // For GCC pillars, we use the specific context function
                    detailedDescription = `${kpi.name} is currently rated **${kpi.status.toUpperCase()}** at ${kpi.value} ${kpi.units}. ${kpi.description}`;
                }
                
                setActiveModalData({
                    title: kpi.name,
                    icon: 'üí°',
                    subtitle: 'Key Performance Indicator Details',
                    status: kpi.status,
                    description: detailedDescription,
                    value: kpi.value,
                    units: kpi.units,
                    ref: kpi.compare,
                    markers: [] 
                });
            };

            const handleSystemClick = (categoryKey) => {
                const system = systemCategories[categoryKey];
                // Pass ONLY primary markers to the modal for the breakdown visualization
                const stats = getSystemStats(categoryKey, true); 
                
                // Filter down to show only primary markers in the modal list for clarity (27 markers logic)
                const primaryMarkersInSystem = stats.markers.filter(m => m.isPrimary);
                
                setActiveModalData({
                    title: system.name,
                    icon: system.icon,
                    subtitle: `Breakdown of Core Primary Markers (${primaryMarkersInSystem.length} markers)`,
                    status: stats.critical > 0 ? 'critical' : stats.warning > 0 ? 'warning' : 'optimal',
                    description: `Analysis based on the 27 Core Markers shows ${stats.critical} critical and ${stats.warning} warning indicators in this system. Targeted intervention based on this subset is recommended.`,
                    markers: primaryMarkersInSystem
                });
            };
            
            const handleCloseModal = () => setActiveModalData(null);
            
            // --- AI Report Data Generation ---
            const reportData = useMemo(() => getAIReport(selectedPatient, getSystemStats), [selectedPatient, getSystemStats]);
            
            // --- REPORT GENERATION TRIGGER ---
            const handleReportClick = () => {
                if (activeTab !== 'report') {
                    setActiveTab('report');
                    setIsGeneratingReport(true);
                } else {
                    setActiveTab('cockpit'); // Allow toggling off report if already active
                }
            };
            
            const finishReportGeneration = () => {
                setIsGeneratingReport(false);
                setActiveTab('report');
            };


            // --- TAB/VIEW RENDERING ---
            
            const filteredMarkers = Object.entries(selectedPatient.fullMarkers)
                .filter(([name, m]) => 
                    name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                    (m.role && m.role.toLowerCase().includes(searchTerm.toLowerCase())) ||
                    (m.category && m.category.toLowerCase().includes(searchTerm.toLowerCase()))
                )
                .map(([name, marker]) => ({
                    name: marker.role || name.toUpperCase().replace(/_/g, ' '),
                    value: marker.value,
                    unit: marker.unit,
                    ref: marker.ref,
                    status: marker.status,
                    category: marker.category,
                    isPrimary: marker.isPrimary,
                }));
            
            // Separate lists for rendering clarity in Data Lake
            const allPrimaryMarkers = filteredMarkers.filter(m => m.isPrimary);
            const allSecondaryMarkers = filteredMarkers.filter(m => !m.isPrimary);
            
            // Access Gate (retained for POC structure)
            const [isGated, setIsGated] = useState(
                typeof localStorage !== 'undefined' && localStorage.getItem('burak_access') !== 'granted'
            );
            
            // Calculate total marker counts for the AI Report integrity summary
            const totalMarkers = Object.entries(selectedPatient.fullMarkers).map(([_, m]) => m.status);
            const integrityStats = {
                critical: totalMarkers.filter(s => s === 'critical').length,
                warning: totalMarkers.filter(s => s === 'warning').length,
                optimal: totalMarkers.filter(s => s === 'optimal').length,
                total: totalMarkers.length,
            };


            if (isGated) {
                // If gated, only show the access modal
                return <AccessGateModal setIsGated={setIsGated} />;
            }
            
            if (isGeneratingReport) {
                return <AIGenerationScreen onComplete={finishReportGeneration} />;
            }

            return (
                <div className="min-h-screen text-white p-6">
                    <div className="max-w-7xl mx-auto">
                        
                        {/* Header Banner */}
                        <div className="bg-gradient-to-r from-blue-900 to-cyan-900 p-6 rounded-xl mb-6 shadow-xl glow">
                            <h1 className="text-5xl font-bold mb-2 text-white">üß¨ Burak Data Co-Pilot</h1>
                            <p className="text-blue-200 text-lg">Multi-Omic Health Intelligence Platform</p>
                            <div className="mt-3">
                                <span className="text-xl font-semibold">{selectedPatient.name} ({selectedPatient.age} / {selectedPatient.gender})</span>
                            </div>
                        </div>

                        {/* Patient Navigation (Simplified) */}
                        <div className="flex justify-center items-center mb-6">
                            <select 
                                className="bg-slate-800 border border-blue-500 rounded-lg px-6 py-3 text-white shadow-lg"
                                value={selectedPatient.id}
                                onChange={(e) => setSelectedPatient(demoPatients.find(p => p.id === parseInt(e.target.value)))}
                            >
                                {demoPatients.map(p => (
                                    <option key={p.id} value={p.id}>{p.name} - {p.scenario}</option>
                                ))}
                            </select>
                        </div>
                        
                        {/* Tab Switcher */}
                        <div className="flex gap-4 mb-6">
                            <button 
                                className={`px-8 py-3 rounded-lg font-semibold shadow-md ${activeTab === 'cockpit' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                onClick={() => setActiveTab('cockpit')}
                            >
                                üéØ Cockpit
                            </button>
                            <button 
                                className={`px-8 py-3 rounded-lg font-semibold shadow-md ${activeTab === 'datalake' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                onClick={() => setActiveTab('datalake')}
                            >
                                üíæ Data Lake ({Object.keys(selectedPatient.fullMarkers).length} Markers)
                            </button>
                            <button 
                                className={`px-8 py-3 rounded-lg font-semibold shadow-md ${activeTab === 'report' ? 'bg-blue-600' : 'bg-slate-700 hover:bg-slate-600'}`}
                                onClick={handleReportClick} // Calls the trigger function
                            >
                                üìÑ AI Report
                            </button>
                        </div>

                        {/* --- COCKPIT VIEW --- */}
                        {activeTab === 'cockpit' && (
                            <div className="space-y-8">
                                <h2 className="text-3xl font-bold text-cyan-400 border-b border-slate-700 pb-3">Predictive Metrics & Key Indicators</h2>
                                
                                {/* KPI Cards */}
                                <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
                                    {kpiData.map((kpi, index) => {
                                        const { valueClass } = getStatusClasses(kpi.status);
                                        return (
                                            <div key={index} className="kpi-card p-4 rounded-xl shadow-lg" onClick={() => handleKpiClick(kpi)}>
                                                <div className="text-slate-400 text-sm mb-2">{kpi.name}</div>
                                                <div className="flex justify-between items-end">
                                                    <div className={`${valueClass} text-4xl font-extrabold`}>
                                                        {kpi.value}{kpi.units === '%' ? '%' : ''}
                                                    </div>
                                                    <StatusBadge status={kpi.status} />
                                                </div>
                                                <div className="text-xs text-slate-500 mt-2">{kpi.description}</div>
                                            </div>
                                        );
                                    })}
                                </div>
                                
                                {/* GCC Health Pillars */}
                                <GCCHealthPillars selectedPatient={selectedPatient} onPillarClick={handleKpiClick} />
                                
                                {/* System Convergence */}
                                <div className={`p-4 rounded-lg shadow-xl ${selectedPatient.systemicRisk >= 70 ? 'bg-red-900/40 border border-red-700' : 'bg-slate-700/50 border border-blue-600'}`}>
                                    <div className="font-bold text-xl mb-1 flex items-center gap-2">
                                        <span className="text-3xl">üö®</span> System Convergence
                                    </div>
                                    <div className="text-lg text-slate-200">{selectedPatient.convergence}</div>
                                </div>

                                {/* System Breakdown */}
                                <div>
                                    <h3 className="text-2xl font-bold text-blue-400 border-b border-slate-700 pb-2 mb-4">Functional System Breakdown (27 Primary Markers)</h3>
                                    <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                                        {Object.entries(systemCategories).map(([key, sys]) => {
                                            const stats = getSystemStats(key, false, selectedPatient); // false ensures only primary markers are used
                                            const status = stats.critical > 0 ? 'critical' : stats.warning > 0 ? 'warning' : 'optimal';
                                            const { badgeClass } = getStatusClasses(status);
                                            
                                            return (
                                                <div key={key} className="system-card p-4 rounded-xl shadow-lg" onClick={() => handleSystemClick(key)}>
                                                    <div className="flex items-center gap-2 mb-2">
                                                        <span className="text-2xl">{sys.icon}</span>
                                                        <span className="font-bold">{sys.name}</span>
                                                    </div>
                                                    <div className="text-xs text-slate-400 mb-2">Primary Markers: {stats.markers.length}</div>
                                                    <div className="flex justify-between items-center mt-2">
                                                        <div className="text-sm font-semibold text-slate-200">
                                                            {stats.critical > 0 && <span className="text-red-400">{stats.critical} Critical </span>}
                                                            {stats.warning > 0 && <span className="text-yellow-400">{stats.warning} Warning </span>}
                                                            {(stats.critical + stats.warning === 0) && <span className="text-green-400">All Optimal</span>}
                                                        </div>
                                                        <span className={badgeClass}>{status.toUpperCase()}</span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* --- DATA LAKE VIEW --- */}
                        {activeTab === 'datalake' && (
                            <div className="bg-slate-800 p-6 rounded-lg shadow-xl border border-blue-500">
                                <h2 className="text-3xl font-bold text-cyan-400 border-b border-slate-700 pb-3 mb-6">Full Raw Data Telemetry (253 Markers)</h2>
                                <div className="mb-6">
                                    <input 
                                        type="text"
                                        placeholder="üîç Search all 253 markers by Name, Role, or Category..."
                                        className="w-full bg-slate-700 border border-blue-500 rounded-lg px-4 py-3 text-white"
                                        value={searchTerm}
                                        onChange={(e) => setSearchTerm(e.target.value)}
                                    />
                                </div>

                                <div className="overflow-x-auto rounded-lg border border-slate-700 max-h-[70vh] scrollbar-hide">
                                    <table className="min-w-full divide-y divide-slate-700">
                                        <thead>
                                            <tr className="text-xs font-medium uppercase tracking-wider text-slate-400 bg-slate-700 sticky top-0 z-10">
                                                <th className="px-4 py-3 text-left min-w-[250px]">Marker Name</th>
                                                <th className="px-4 py-3 text-left min-w-[150px]">Platform</th>
                                                <th className="px-4 py-3 text-right min-w-[120px]">Value / Units</th>
                                                <th className="px-4 py-3 text-center min-w-[150px]">Reference Range</th>
                                                <th className="px-4 py-3 text-center min-w-[90px]">Status</th>
                                                <th className="px-4 py-3 text-center min-w-[80px]">Type</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-800">
                                            
                                            {/* Primary Markers Section Header */}
                                            {allPrimaryMarkers.length > 0 && (
                                                <tr className="bg-slate-600/50">
                                                    <td colSpan="6" className="px-4 py-1 text-sm font-bold text-blue-300">
                                                        Core Primary Markers (27)
                                                    </td>
                                                </tr>
                                            )}
                                            
                                            {/* Primary Markers Rows */}
                                            {allPrimaryMarkers.map((marker, index) => {
                                                const { valueClass } = getStatusClasses(marker.status);
                                                return (
                                                    <tr key={marker.name} className="primary-row">
                                                        <td className="px-4 py-3 text-sm font-semibold text-white">
                                                            <span className="text-blue-300">{marker.name}</span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-slate-400">
                                                            {systemCategories[marker.category]?.name || marker.category}
                                                        </td>
                                                        <td className={`px-4 py-3 text-sm text-right font-mono ${valueClass}`}>
                                                            {marker.value} {marker.unit}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-center text-slate-500">
                                                            {marker.ref}
                                                        </td>
                                                        <td className="px-4 py-3 text-center">
                                                            <StatusBadge status={marker.status} />
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-center">
                                                            <span className="text-xs font-bold text-red-400">PRI</span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                            
                                            {/* Secondary Markers Section Header */}
                                            {allSecondaryMarkers.length > 0 && (
                                                <tr className="bg-slate-600/50">
                                                    <td colSpan="6" className="px-4 py-1 text-sm font-bold text-green-300">
                                                        Secondary Omics Data ({Object.keys(selectedPatient.fullMarkers).length - 27} Markers)
                                                    </td>
                                                </tr>
                                            )}

                                            {/* Secondary Markers Rows */}
                                            {allSecondaryMarkers.map((marker, index) => {
                                                const { valueClass } = getStatusClasses(marker.status);
                                                return (
                                                    <tr key={marker.name} className={`marker-row bg-slate-800`}>
                                                        <td className="px-4 py-3 text-sm font-medium text-white">
                                                            <span className="text-slate-200">{marker.name}</span>
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-slate-500">
                                                            {systemCategories[marker.category]?.name || marker.category}
                                                        </td>
                                                        <td className={`px-4 py-3 text-sm text-right font-mono ${valueClass}`}>
                                                            {marker.value} {marker.unit}
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-center text-slate-500">
                                                            {marker.ref}
                                                        </td>
                                                        <td className="px-4 py-3 text-center">
                                                            <StatusBadge status={marker.status} />
                                                        </td>
                                                        <td className="px-4 py-3 text-sm text-center">
                                                            <span className="text-xs font-bold text-green-400">SEC</span>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                            {(allPrimaryMarkers.length + allSecondaryMarkers.length) === 0 && (
                                                <tr>
                                                    <td colSpan="6" className="py-8 text-center text-slate-500">
                                                        No markers found matching "{searchTerm}".
                                                    </td>
                                                </tr>
                                            )}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                        
                        {/* --- AI REPORT VIEW --- */}
                        {activeTab === 'report' && (
                            <div className="ai-report-container">
                                <div className="ai-report-header">
                                    <h2 className="text-4xl font-bold mb-1 text-cyan-400">CLINICAL INTELLIGENCE REPORT - GCC PRECISION MEDICINE</h2>
                                    <p className="text-blue-200 text-lg">Generated: {new Date("2025-12-16").toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} | Patient: GCC-2024-00{selectedPatient.id} | Region: Qatar</p>
                                </div>
                                <div className="space-y-0 pt-0">

                                    {/* AI TRANSPARENCY WARNING */}
                                    <div className="report-section bg-yellow-900/30 border-l-4 border-yellow-500">
                                        <h3 className="report-section-title text-yellow-300">
                                            ‚ö†Ô∏è POC STATUS WARNING: TEMPLATE NARRATIVE
                                        </h3>
                                        <p className="text-sm text-yellow-200 font-semibold">
                                            The narrative and clinical context below are **dynamically populated with patient data** but generated from generic templates based on the patient's risk profile (Critical/Warning/Optimal).
                                        </p>
                                        <p className="text-xs text-yellow-300 mt-1">
                                            In production, Gemini AI will perform true Natural Language Processing (NLP) to create a unique, highly personalized report.
                                        </p>
                                    </div>
                                    
                                    {/* EXECUTIVE SUMMARY */}
                                    <div className="report-section">
                                        <h3 className="report-section-title text-slate-300">EXECUTIVE SUMMARY</h3>
                                        <p className="text-slate-300 whitespace-pre-wrap">{reportData.executiveSummary}</p>
                                    </div>
                                    
                                    {/* MARKER INTEGRITY SUMMARY (NEW BLOB SECTION) */}
                                    <div className="report-section">
                                        <h3 className="report-section-title">BIOMARKER INTEGRITY SUMMARY ({integrityStats.total} TOTAL MARKERS)</h3>
                                        <div className="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                                            <div className="bg-green-900/40 p-4 rounded-xl border border-green-700">
                                                <span className="text-3xl block text-green-400">{integrityStats.optimal}</span>
                                                <p className="text-xs text-green-300 font-semibold">Optimal Range</p>
                                            </div>
                                            <div className="bg-yellow-900/40 p-4 rounded-xl border border-yellow-700">
                                                <span className="text-3xl block text-yellow-400">{integrityStats.warning}</span>
                                                <p className="text-xs text-yellow-300 font-semibold">Warning/Elevated</p>
                                            </div>
                                            <div className="bg-red-900/40 p-4 rounded-xl border border-red-700">
                                                <span className="text-3xl block text-red-400">{integrityStats.critical}</span>
                                                <p className="text-xs text-red-300 font-semibold">Critical Attention</p>
                                            </div>
                                            <div className="bg-blue-900/40 p-4 rounded-xl border border-blue-700">
                                                <span className="text-3xl block text-blue-400">{integrityStats.total}</span>
                                                <p className="text-xs text-blue-300 font-semibold">Total Analyzed</p>
                                            </div>
                                        </div>
                                    </div>


                                    {/* CRITICAL FINDINGS (Insight Cards) */}
                                    <div className="report-section">
                                        <h3 className="report-section-title text-red-400">CRITICAL FINDINGS (GCC-CONTEXTUALIZED)</h3>
                                        <div className="space-y-4">
                                            {reportData.criticalFindings.map((finding, index) => {
                                                const status = finding.status;
                                                const color = status === 'critical' ? 'border-red-500' : 'border-yellow-500';

                                                return (
                                                    <div key={index} className={`insight-card ${color} border-l-4 p-4 rounded-lg shadow-md bg-slate-900/80`}>
                                                        <div className="flex justify-between items-start">
                                                            <h4 className="title text-lg mb-2 flex items-center text-red-300">
                                                                <span className="text-2xl mr-2">üí°</span> {finding.title}
                                                            </h4>
                                                            <StatusBadge status={status} />
                                                        </div>

                                                        <div className="text-sm text-slate-300 space-y-2 pt-1">
                                                            <p className="font-semibold text-white whitespace-pre-wrap">{finding.pattern}</p>
                                                            <p className="text-yellow-400 whitespace-pre-wrap">{finding.risk}</p>
                                                            <p className="text-slate-400 whitespace-pre-wrap">{finding.context}</p>
                                                            <p className="text-cyan-400 whitespace-pre-wrap">{finding.ramadan}</p>
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                    
                                    
                                    {/* Primary Marker Table Snapshot */}
                                    <AIReportPrimaryMarkerTable selectedPatient={selectedPatient} />

                                    {/* INTERVENTION STRATEGY */}
                                    <div className="report-section">
                                        <h3 className="report-section-title text-green-400">GCC-SPECIFIC INTERVENTION STRATEGY</h3>
                                        <div className="space-y-4">
                                            {reportData.interventionStrategy.map((section, index) => (
                                                <div key={index} className="bg-slate-700/50 p-4 rounded-lg border-l-4 border-green-500">
                                                    <h4 className="font-bold text-base text-white mb-2">{section.title}</h4>
                                                    <ul className="list-disc list-inside text-slate-300 ml-4 space-y-1">
                                                        {section.points.map((item, i) => <li key={i} className="text-sm">{item}</li>)}
                                                    </ul>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* PROGNOSIS */}
                                    <div className="report-section">
                                        <h3 className="report-section-title text-cyan-400">PROGNOSIS</h3>
                                        <p className="text-slate-300 whitespace-pre-wrap">{reportData.prognosis}</p>
                                    </div>
                                    
                                </div>
                            </div>
                        )}
                        
                    </div>
                    
                    {activeModalData && <DeepDiveModal data={activeModalData} onClose={handleCloseModal} />}

                    <footer className="bg-slate-900 py-6 mt-12 rounded-lg text-center border-t border-slate-700">
                        <div className="text-slate-400">Developed by <span className="font-semibold text-yellow-400">waseem ahanger ‚ù§Ô∏è</span> on <span className="text-blue-400">Google Cloud Platform</span>.</div>
                    </footer>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
